echo "Starting provision..."

ROCKYOU="/usr/share/wordlists/rockyou.txt.gz"
LINPEAS="/opt/linpeas.sh"
PSPY="/opt/pspy64"
PWNCAT_DIR="/opt/pwncat"
export DEBIAN_FRONTEND=noninteractive

#Creates a copy if it not exists
cp -n .zshrc .zshrc.bak

# Copies the original content to .zshrc to prevent duplicates
cp .zshrc.bak .zshrc

# Adds the ability to do partial search on up and down arrow
cat >> .zshrc <<-EOF

export PATH=/home/vagrant/.local/bin:$PATH

autoload -U up-line-or-beginning-search
autoload -U down-line-or-beginning-search
zle -N up-line-or-beginning-search
zle -N down-line-or-beginning-search
bindkey "\${terminfo[kcuu1]}" up-line-or-beginning-search # Up
bindkey "\${terminfo[kcud1]}" down-line-or-beginning-search # Down

# Use Ctrl-V to edit the command line in editor
autoload edit-command-line; zle -N edit-command-line
bindkey '^v' edit-command-line
EOF

apt -qq -y install seclists python3.10-venv jq 2>/dev/null

if [[  ! -d "$PWNCAT_DIR" ]]; then
    git clone https://github.com/calebstewart/pwncat.git $PWNCAT_DIR
    python -m venv $PWNCAT_DIR
    $PWNCAT_DIR/bin/pip install pwncat-cs
    rm -f /usr/local/bin/pwncat-cs
    ln -s $PWNCAT_DIR/bin/pwncat-cs /usr/local/bin
fi


# unpacking rockyou

if [ -f "$ROCKYOU" ]; then
    echo "Unzipping rockyou..."
    gunzip $ROCKYOU
fi

if [ ! -f "$LINPEAS" ]; then
    echo "Downloading linpeas"
    wget -nv https://github.com/carlospolop/PEASS-ng/releases/latest/download/linpeas.sh -P /opt
    chmod +x $LINPEAS
fi

if [ ! -f "$PSPY" ]; then
    echo "Downloading pspy"
    wget -nv https://github.com/DominicBreuker/pspy/releases/download/v1.2.0/pspy64 -P /opt
    chmod +x $PSPY
fi

echo "Finishing provision !"
